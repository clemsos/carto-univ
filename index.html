<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/9.0.0/nouislider.css" media="screen" title="no title" charset="utf-8">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" />

  <style>

    input[type=range] {
      width: 100%
    }

    #map {
      height: 80%;
    }

  </style>

</head>
<body>

  <div id="slider"></div>
  <p>Selection : <span id="year">1400</span></p>

   <div id="map"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.js" charset="utf-8"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/9.0.0/nouislider.js
  " charset="utf-8"></script>
  <script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>


  <script>

    // setup map
    let map = L.map('map').setView([51.505, -0.09], 4);

    let url = 'http://tile.thunderforest.com/transport/{z}/{x}/{y}.png'
    let attribution = '&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'

    L.tileLayer(url, {
        attribution: attribution,
        minZoom: 0,
      	maxZoom: 20,
      	ext: 'png'
    }).addTo(map);

    // create storage
    const markers = new L.FeatureGroup()

    // store all circles objects
    const coords = {}
    // load geo coordinates
    d3.json("data/geocodes-google.json", geoData => {
      Object.keys(geoData).forEach( (d,i) => {
        let geo = geoData[d]
        if(geo.lat && geo.lng) coords[d] = [geo.lat, geo.lng]
      })
    })

    //
    d3.csv("data/universites.csv", data => {
      const years = Object.keys(data[0]).map(d => parseInt(d) )

      // default values
      console.log(d3.min(years), d3.max(years))

      let year = d3.min(years)

      // init visual rendering on map
      initMarkers(data, year)

      // create slider
      const slider = document.getElementById('slider')

      noUiSlider.create(slider, {
      	start: year,
      	connect: true,
        step: 20,
      	range: {
      		'min': d3.min(years),
      		'max': d3.max(years)
      	},
        pips: {
          mode: 'count',
          values: 10,
          density: 1,
          stepped: true
        }
      })

      // show slider value on the page
      slider.noUiSlider.on('slide', value => {
        year  = Math.floor(value)
        d3.select("#year").text(year)
        updateMarkers(data, year)
      })

    })


    const circles = {}
    function initMarkers(data, year) {

      // loop through data
      data.map(d => {
        let name  = d["Université"]
        let coord = coords[name]
        if (coord) {
          circles[name] = L.circle(coord, {
              color: 'red',
              fillColor: '#f03',
              fillOpacity: 0.5,
              radius: 50
          })

          circles[name].bindPopup(d, { showOnMouseOver: true });
          markers.addLayer(circles[name])
        }
      })
      map.addLayer(markers)
      markers.bringToFront()
    }

    function updateMarkers(data, year){

      console.log("updated")
      // loop through data
      data.map(d => {

        let count = []
        let name  = d["Université"]
        if(d[year]) count = d[year].split(":")

        let circle = circles[name]

        if(name && coords[name] && count.length > 1 && circle) {

          let coord = coords[name]
          let c = parseInt(count[1])

          circle.setRadius(c*30)
          markers.addLayer(circle)
        }
      })

      map.addLayer(markers)
    }
  </script>
</body>
